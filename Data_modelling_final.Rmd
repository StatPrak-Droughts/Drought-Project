---
title: "Data_modelling_final"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(mgcv)
library(verification)
 
hydro_summer <- readRDS(file = "./data/hydro_summer.RDS")
hydro_winter <- readRDS(file = "./data/hydro_winter.RDS")
hydro_total <- readRDS(file = "./data/hydro_total.RDS")
pegel_prop <- readRDS(file = "./data/pegel_prop.RDS")

hydro_summer_10304 <- readRDS("data/hydro_summer_10304.RDS")
hydro_summer_11502 <- readRDS("data/hydro_summer_11502.RDS")
hydro_summer_20203 <- readRDS("data/hydro_summer_20203.RDS")

hydro_winter_10304 <- readRDS("data/hydro_winter_10304.RDS")
hydro_winter_11502 <- readRDS("data/hydro_winter_11502.RDS")
hydro_winter_20203 <- readRDS("data/hydro_winter_20203.RDS")

hydro_summer_10304_kbe <- readRDS(file = "data/hydro_summer_10304_kbe.RDS")
hydro_winter_10304_kbe <- readRDS(file = "data/hydro_winter_10304_kbe.RDS")
hydro_summer_11502_kbe <- readRDS(file = "data/hydro_summer_11502_kbe.RDS")
hydro_winter_11502_kbe <- readRDS(file = "data/hydro_winter_11502_kbe.RDS")
hydro_summer_20203_kbe <- readRDS(file = "data/hydro_summer_20203_kbe.RDS")
hydro_winter_20203_kbe <- readRDS(file = "data/hydro_winter_20203_kbe.RDS")
```


# Fränksiche Saale Salz

## Sommer
###Volles Modell
```{r}
gam_all_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")
summary(gam_all_summer_20203)

# avg_precip, avg_snowstorage, avg_infiltration and avg_snowstorage_drain linear
gam2_all_summer_20203 <- gam(formula = lowlevel ~ YY + avg_precip + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + avg_snowstorage + s(groundwaterdepth, bs = "ps") + avg_infiltration + s(max_precip, bs = "ps") + avg_snowstorage_drain, family = binomial(), data = hydro_summer_20203_kbe, method = "REML")
summary(gam2_all_summer_20203)
plot(gam2_all_summer_20203)

```

###getrimmtes Modell
```{r}
# avg_snowstorage_drain raus, da nicht sign. 
gam_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + avg_infiltration + avg_snowstorage_drain, family = binomial(), data = hydro_summer_20203_kbe, method = "REML")
summary(gam_selected_summer_20203)
plot(gam_selected_summer_20203)


```
### Gam mit Splines
```{r}
# avg_precip und max_precip raus, da nicht sign. 
gam_selected_interact_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + avg_infiltration + avg_snowstorage_drain + s(groundwaterdepth, by = avg_infiltration, bs = "ps") + s(avg_precip, by = groundwaterdepth, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")
summary(gam_selected_interact_summer_20203)
AIC(gam_selected_interact_summer_20203)
plot(gam_selected_summer_20203)

```
### AIC Vergleich
```{r}
AIC(gam2_all_summer_20203)
AIC(gam_selected_summer_20203)
AIC(gam_selected_interact_summer_20203)

```
### Sommer Modelle Speichern
```{r}
save(gam2_all_summer_20203, file = "./models/20203/gam2_all_summer_20203.Rdata")
save(gam_selected_summer_20203, file = "./models/20203/gam_selected_summer_20203.Rdata")
save(gam_selected_interact_summer_20203, file = "./models/20203/gam_selected_interact_summer_20203.Rdata")

```

### Plots speichern
```{r}
jpeg("./Plots/Jonas/effects_gam2_all_summer_20203.jpg", width = 700, height = 600)
layout(matrix(1:6, ncol = 3, nrow = 2))
plot(gam_selected_summer_20203, select = 1, ylim = c(-10, 20))
plot(gam_selected_summer_20203, select = 2, ylim = c(-10, 10))
plot(gam_selected_summer_20203, select = 3, ylim = c(-20,20))
plot(gam_selected_summer_20203, select = 4, ylim = c(-30, 10))
plot(gam_selected_summer_20203, select = 5, ylim = c(- 2000, 2000))
plot(gam_selected_summer_20203, select = 6, ylim = c(-20, 20))

```

### Nicht Skaliert
```{r}
# GLM: all possible drivers
glm_all_summer_20203 <- glm(formula = lowlevel ~ YY + avg_precip + avg_airtmp + avg_glorad + avg_relhum + avg_soilwater + avg_snowstorage + groundwaterdepth + avg_infiltration + max_precip + avg_snowstorage_drain, family = binomial(), data = hydro_summer_20203_kbe)
summary(glm_all_summer_20203)

# GLM: AIC variable selection
library(MASS)
stepAIC(glm_all_summer_20203, direction = "both")
# Variablen YY, avg_precip, avg_airtmp, avg_relhum, avg_soilwater, avg_snowstorage, groundwaterdepth, avg_infiltration, max_precip ausgewählt

# GAM: only selected drivers
library(mgcv)
gam_aicselected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")
summary(gam_aicselected_summer_20203)
# Plots für alle 
plot(gam_aicselected_summer_20203, ylim = c(-40, 40))
# PLot reskaled für snowstorage
plot(gam_aicselected_summer_20203, select = 5)
plot(gam_aicselected_summer_20203, select = 5, se = FALSE)
```

```{r Verschiedene GAMs testen}
# GAM linear
gam_aicselected_summer_20203_lin <- gam(formula = lowlevel ~ YY + avg_precip + avg_airtmp + avg_relhum + avg_soilwater + avg_snowstorage + groundwaterdepth + avg_infiltration + max_precip, family = binomial(), data = hydro_summer_20203_kbe, method = "REML")
## Interaktionen
gam1_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_precip, by = avg_airtmp, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam2_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_precip, by = avg_snowstorage, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam3_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_precip, by = groundwaterdepth, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam4_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_precip, by = avg_infiltration, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam5_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_precip, by = max_precip, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam6_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_precip, by = avg_soilwater, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam7_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_precip, by = avg_relhum, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam8_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_airtmp, by = avg_relhum, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam9_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_airtmp, by = avg_soilwater, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam10_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_airtmp, by = avg_snowstorage, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam11_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_airtmp, by = groundwaterdepth, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam12_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_airtmp, by = avg_infiltration, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam13_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_airtmp, by = max_precip, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam14_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_relhum, by = avg_soilwater, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam15_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_relhum, by = avg_snowstorage, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam16_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_relhum, by = groundwaterdepth, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam17_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_relhum, by = avg_infiltration, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam18_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_relhum, by = max_precip, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam19_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_soilwater, by = avg_snowstorage, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam20_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_soilwater, by = groundwaterdepth, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam21_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_soilwater, by = avg_infiltration, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam22_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_soilwater, by = avg_infiltration, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam23_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_snowstorage, by = groundwaterdepth, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam24_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_snowstorage, by = avg_infiltration, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam25_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_snowstorage, by = max_precip, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam26_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(groundwaterdepth, by = avg_infiltration, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam27_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(groundwaterdepth, by = max_precip, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

gam28_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_infiltration, by = max_precip, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")


# Visuelles Modell Anhand von Effektplots
gam_summer_20203_plots <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_soilwater, bs = "ps")+ s(avg_snowstorage, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")



## Summaries 
summary(gam_summer_20203_plots)
AIC(gam_summer_20203_plots)
# Deviance explained = 62.1%
#AIC 2018
summary(gam_selected_summer_20203_lin)
AIC(gam_selected_summer_20203_lin)
# Deviance explained = 63.4%
#AIC 2009
summary(gam_selected_summer_20203)
AIC(gam_selected_summer_20203)
# Deviance explained =7.3.%
#AIC 1513.111
summary(gam1_selected_summer_20203)
AIC(gam1_selected_summer_20203)
# Deviance explained =73.3%
#AIC 1483
summary(gam2_selected_summer_20203)
AIC(gam2_selected_summer_20203)
# Deviance explained =72.9%
#AIC 1529
summary(gam3_selected_summer_20203)
AIC(gam3_selected_summer_20203)
# Deviance explained = 73.4%
#AIC 1513
summary(gam4_selected_summer_20203)
AIC(gam4_selected_summer_20203)
# Deviance explained =73.6%
#AIC 1508
summary(gam5_selected_summer_20203)
AIC(gam5_selected_summer_20203)
# Deviance explained =73.8%
#AIC 1501
summary(gam6_selected_summer_20203)
AIC(gam6_selected_summer_20203)
# Deviance explained =74%
#AIC 1483
summary(gam7_selected_summer_20203)
AIC(gam7_selected_summer_20203)
# Deviance explained =78%
#AIC 1490
summary(gam8_selected_summer_20203)
AIC(gam8_selected_summer_20203)
# Deviance explained =73.5%
#AIC 1508
summary(gam9_selected_summer_20203)
AIC(gam9_selected_summer_20203)
# Deviance explained =73.6%
#AIC 1504
summary(gam10_selected_summer_20203)
AIC(gam10_selected_summer_20203)
# Deviance explained =73.4%
#AIC 1513
summary(gam11_selected_summer_20203)
AIC(gam11_selected_summer_20203)
# Deviance explained =73.4%
#AIC 1511
summary(gam12_selected_summer_20203)
AIC(gam12_selected_summer_20203)
# Deviance explained =73.8%
#AIC 1504
summary(gam13_selected_summer_20203)
AIC(gam13_selected_summer_20203)
# Deviance explained =73.6%
#AIC 1515
summary(gam14_selected_summer_20203)
AIC(gam14_selected_summer_20203)
# Deviance explained =73.3%
#AIC 1514
summary(gam15_selected_summer_20203)
AIC(gam15_selected_summer_20203)
# Deviance explained =73.4%
#AIC 1513
summary(gam16_selected_summer_20203)
AIC(gam16_selected_summer_20203)
# Deviance explained =73.3%
#AIC 1514
summary(gam17_selected_summer_20203)
AIC(gam17_selected_summer_20203)
# Deviance explained =73.6%
#AIC 1509
summary(gam18_selected_summer_20203)
AIC(gam18_selected_summer_20203)
# Deviance explained =73.4%
#AIC 1513
summary(gam19_selected_summer_20203)
AIC(gam19_selected_summer_20203)
# Deviance explained =73.4%
#AIC 1511
summary(gam20_selected_summer_20203)
AIC(gam20_selected_summer_20203)
# Deviance explained =73.5%
#AIC 1509
summary(gam21_selected_summer_20203)
AIC(gam21_selected_summer_20203)
# Deviance explained =78%
#AIC 
summary(gam22_selected_summer_20203)
# Deviance explained =73.9%
#AIC 1499
summary(gam23_selected_summer_20203)
AIC(gam23_selected_summer_20203)
# Deviance explained =73.3%
#AIC 1514
summary(gam24_selected_summer_20203)
AIC(gam24_selected_summer_20203)
# Deviance explained =73.3%
#AIC 1515
summary(gam25_selected_summer_20203)
AIC(gam25_selected_summer_20203)
# Deviance explained =72.7
#AIC 1541
summary(gam26_selected_summer_20203)
AIC(gam26_selected_summer_20203)
# Deviance explained =74.4%
#AIC 1475
summary(gam27_selected_summer_20203)
AIC(gam27_selected_summer_20203)
# Deviance explained =73.9%
#AIC 1504
summary(gam28_selected_summer_20203)
AIC(gam28_selected_summer_20203)
# Deviance explained =73.7%
#AIC 1500
```
###Skaliert
```{r}

glm_all_summer_20203_scaled <- glm(formula = lowlevel ~ YY + avg_precip_scaled + avg_airtmp_scaled + avg_glorad_scaled + avg_relhum_scaled + avg_soilwater_scaled + avg_snowstorage_scaled + groundwaterdepth_scaled + avg_infiltration_scaled + max_precip_scaled + avg_snowstorage_drain_scaled, family = binomial(), data = hydro_summer_20203_kbe)

summary(glm_all_summer_20203_scaled)

# GLM: AIC variable selection
library(MASS)
stepAIC(glm_all_summer_20203_scaled, direction = "both")
# YY + avg_precip_scaled + avg_airtmp_scaled + avg_relhum_scaled + 
  # avg_soilwater_scaled + avg_snowstorage_scaled + groundwaterdepth_scaled + 
    # avg_infiltration_scaled + max_precip_scaled

# Gam mit ausgewählten Variablen
gam_selected_summer_20203_scaled <- gam(formula = lowlevel ~ YY + s(avg_precip_scaled, bs = "ps") + s(avg_airtmp_scaled, bs = "ps") + s(avg_relhum_scaled, bs = "ps") + s(avg_soilwater_scaled, bs = "ps") + s(avg_snowstorage_scaled, bs = "ps") + s(groundwaterdepth_scaled, bs = "ps") + s(avg_infiltration_scaled, bs = "ps") + s(max_precip_scaled, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

# Plots für alle 
plot(gam_selected_summer_20203_scaled, ylim = c(-40, 40))
# PLot reskaled für snowstorage
plot(gam_selected_summer_20203_scaled, select = 4)
plot(gam_selected_summer_20203_scaled, select = 4, se = FALSE)


```

```{r Verschiedene GAMs testen}
# Visuelles Modell Anhand von Effektplots
gam_summer_20203_scaled_plots <- gam(formula = lowlevel ~ YY + s(avg_precip_scaled, bs = "ps") + s(avg_soilwater_scaled, bs = "ps")+ s(avg_snowstorage_scaled, bs = "ps") + s(avg_infiltration_scaled, bs = "ps") + s(max_precip_scaled, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")

summary(gam_summer_20203_scaled_plots)
AIC(gam_summer_20203_scaled_plots)
# Deviance explained = 62.1%
#AIC 2108

summary(gam_selected_summer_20203_scaled)
AIC(gam_selected_summer_20203_scaled)
# Deviance explained = 73.3%
#AIC 1513
```


## Winter
###Volles Modell
```{r}
gam_all_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")
summary(gam_all_winter_20203)
AIC(gam_all_winter_20203)
# avg_precip, avg_infiltration and avg_snowstorage_drain linear
gam2_all_winter_20203 <- gam(formula = lowlevel ~ YY + avg_precip + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + avg_infiltration + s(max_precip, bs = "ps") + avg_snowstorage_drain, family = binomial(), data = hydro_winter_20203_kbe, method = "REML")
summary(gam2_all_winter_20203)
plot(gam2_all_winter_20203)

```

###getrimmtes Modell
```{r}
# max_precip und avg_precip raus, da nicht sign. 
gam_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + avg_infiltration + avg_snowstorage_drain, family = binomial(), data = hydro_winter_20203_kbe, method = "REML")
summary(gam_selected_winter_20203)
plot(gam_selected_winter_20203)

```
### Gam mit Splines
```{r}
# avg_precip und max_precip raus, da nicht sign. 
gam_selected_interact_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + avg_infiltration + avg_snowstorage_drain + s(avg_soilwater, by = avg_snowstorage, bs = "ps") + s(avg_airtmp, by = avg_snowstorage, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")
summary(gam_selected_interact_winter_20203)
plot(gam_selected_winter_20203)
```
### AIC Verlgeich
```{r}
AIC(gam2_all_winter_20203)
AIC(gam_selected_winter_20203)
AIC(gam_selected_interact_winter_20203)
```


```{r}
save(gam2_all_winter_20203, file = "./models/20203/gam2_all_winter_20203.Rdata")
save(gam_selected_winter_20203, file = "./models/20203/gam_selected_winter_20203.Rdata")
save(gam_selected_interact_winter_20203, file = "./models/20203/gam_selected_interact_winter_20203.Rdata")
```


### Nicht skaliert
```{r}
# GLM: all possible drivers
glm_all_winter_20203 <- glm(formula = lowlevel ~ YY + avg_precip + avg_airtmp + avg_glorad + avg_relhum + avg_soilwater + avg_snowstorage + groundwaterdepth + avg_infiltration + max_precip + avg_snowstorage_drain, family = binomial(), data = hydro_winter_20203_kbe)
summary(glm_all_winter_20203)  

# GLM: AIC variable selection
library(MASS)
stepAIC(glm_all_winter_20203, direction = "both")
# Variablen YY, avg_airtmp, avg_relhum, avg_soilwater, avg_snowstorage, groundwaterdepth, avg_infiltration, avg_snowstorage_drain ausgewählt

# GAM: only selected drivers
library(mgcv)
gam_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")
summary(gam_selected_winter_20203)
plot(gam_selected_winter_20203, ylim = c(-40, 40))
# PLot reskaled für snowstorage
plot(gam_selected_winter_20203, select = 4)
plot(gam_selected_winter_20203, select = 5, se = FALSE, ylim = c(-40, 40))
```

```{r Verschiedene GAMs testen}
#Volles GAM linear
gam_selected_winter_20203_lin <- gam(formula = lowlevel ~ YY + avg_airtmp + avg_relhum + avg_soilwater + avg_snowstorage + groundwaterdepth + avg_infiltration + avg_snowstorage_drain, family = binomial(), data = hydro_winter_20203_kbe, method = "REML")
## Interaktionen
gam1_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_airtmp, by = avg_relhum, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")

gam2_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_airtmp, by = avg_soilwater, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")

gam3_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_airtmp, by = avg_snowstorage, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")

gam4_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_airtmp, by = groundwaterdepth, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")

gam5_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_airtmp, by = avg_infiltration, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")

gam6_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_airtmp, by = avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")

gam7_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_relhum, by = avg_soilwater, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")

gam8_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_relhum, by = avg_snowstorage, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")

gam9_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_relhum, by = groundwaterdepth, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")

gam10_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_relhum, by = avg_infiltration, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")

gam11_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_relhum, by = avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")

gam12_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_soilwater, by = avg_snowstorage, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")

gam13_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_soilwater, by = groundwaterdepth, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")

gam14_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_soilwater, by = avg_infiltration, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")

gam15_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_soilwater, by = avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")

gam16_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_snowstorage, by = groundwaterdepth, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")

gam17_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_snowstorage, by = avg_infiltration, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")

gam18_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_snowstorage, by = avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")

gam19_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(groundwaterdepth, by = avg_infiltration, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")

gam20_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(groundwaterdepth, by = avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")

gam21_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_infiltration, by = avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")


# Visuelles Modell Anhand von Effektplots
gam_winter_20203_plots <- gam(formula = lowlevel ~ YY + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(avg_infiltration, bs = "ps") + s(avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")


summary(gam_winter_20203_plots)
AIC(gam_winter_20203_plots)
#Deviance explained = 74.5%
#AIC 670

summary(gam_selected_winter_20203_lin)
AIC(gam_selected_winter_20203_lin)
# Deviance explained = 61.1%
#AIC
summary(gam_selected_winter_20203)
AIC(gam_selected_winter_20203)
# Deviance explained = 78.1%
#AIC 598
summary(gam1_selected_winter_20203)
AIC(gam1_selected_winter_20203)
# Deviance explained = 78.1%
#AIC 601
summary(gam2_selected_winter_20203)
AIC(gam2_selected_winter_20203)
# Deviance explained = 78.9%
#AIC 595
summary(gam3_selected_winter_20203)
AIC(gam3_selected_winter_20203)
# Deviance explained = 79.7%
#AIC 574
summary(gam4_selected_winter_20203)
AIC(gam4_selected_winter_20203)
# Deviance explained = 78.1%
#AIC 606
summary(gam5_selected_winter_20203)
AIC(gam5_selected_winter_20203)
# Deviance explained =  78%
#AIC 608
summary(gam6_selected_winter_20203)
AIC(gam6_selected_winter_20203)
# Deviance explained = 79.4%
#AIC 585
summary(gam7_selected_winter_20203)
AIC(gam7_selected_winter_20203)
# Deviance explained = 78.1%
#AIC 609
summary(gam8_selected_winter_20203)
AIC(gam8_selected_winter_20203)
# Deviance explained = 78.9%
#AIC 587
summary(gam9_selected_winter_20203)
AIC(gam9_selected_winter_20203)
# Deviance explained = 78.2%
#AIC 603
summary(gam10_selected_winter_20203)
AIC(gam10_selected_winter_20203)
# Deviance explained = 78.2%
#AIC 601
summary(gam11_selected_winter_20203)
AIC(gam11_selected_winter_20203)
# Deviance explained = 79.1%
#AIC 584
summary(gam12_selected_winter_20203)
AIC(gam12_selected_winter_20203)
# Deviance explained = 83.3%
#AIC 484
summary(gam13_selected_winter_20203)
AIC(gam13_selected_winter_20203)
# Deviance explained = 78.7%
#AIC 590
summary(gam14_selected_winter_20203)
AIC(gam14_selected_winter_20203)
# Deviance explained =   78%
#AIC608
summary(gam15_selected_winter_20203)
AIC(gam15_selected_winter_20203)
# Deviance explained = 80.1%
#AIC 564
summary(gam16_selected_winter_20203)
AIC(gam16_selected_winter_20203)
# Deviance explained =  78%
#AIC 608
summary(gam17_selected_winter_20203)
AIC(gam17_selected_winter_20203)
# Deviance explained = 78.2%
#AIC 604
summary(gam18_selected_winter_20203)
AIC(gam18_selected_winter_20203)
# Deviance explained = 78.4%
#AIC 602
summary(gam19_selected_winter_20203)
AIC(gam19_selected_winter_20203)
# Deviance explained = 79.1%
#AIC 588
summary(gam20_selected_winter_20203)
AIC(gam20_selected_winter_20203)
# Deviance explained = 78.4%
#AIC 600
summary(gam21_selected_winter_20203)
AIC(gam21_selected_winter_20203)
# Deviance explained = 78.5% 
#AIC 601



```
### Skaliert
```{r}

glm_all_winter_20203_scaled <- glm(formula = lowlevel ~ YY + avg_precip_scaled + avg_airtmp_scaled + avg_glorad_scaled + avg_relhum_scaled + avg_soilwater_scaled + avg_snowstorage_scaled + groundwaterdepth_scaled + avg_infiltration_scaled + max_precip_scaled + avg_snowstorage_drain_scaled, family = binomial(), data = hydro_winter_20203_kbe)

summary(glm_all_summer_20203_scaled)

# GLM: AIC variable selection
library(MASS)
stepAIC(glm_all_winter_20203_scaled, direction = "both")
#  YY + avg_airtmp_scaled + avg_relhum_scaled + 
  #  avg_soilwater_scaled + avg_snowstorage_scaled + groundwaterdepth_scaled + 
   # avg_infiltration_scaled + avg_snowstorage_drain_scaled

# Gam mit ausgewählten Variablen
gam_selected_winter_20203_scaled <- gam(formula = lowlevel ~ YY + s(avg_airtmp_scaled, bs = "ps") + s(avg_relhum_scaled, bs = "ps") + s(avg_soilwater_scaled, bs = "ps") + s(avg_snowstorage_scaled, bs = "ps") + s(groundwaterdepth_scaled, bs = "ps") + s(avg_infiltration_scaled, bs = "ps") + s(avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")

# Plots für alle 
plot(gam_selected_winter_20203_scaled, ylim = c(-50, 40))
# PLot reskaled für snowstorage
plot(gam_selected_winter_20203_scaled, select = 4)
plot(gam_selected_winter_20203_scaled, select = 4, se = FALSE)




```
```{r Verschiedene GAMs testen }
# Gam
# Visuelles Modell Anhand von Effektplots
## Hier sehen alle wichtig aus
```







# Isar Mittenwald 
## Sommer
# GAM: full modell
```{r}
library(mgcv)
# GAM: all possible drivers
gam2_all_summer_10304 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_summer_10304_kbe, method = "REML")
summary(gam2_all_summer_10304)
AIC(gam2_all_summer_10304)
plot(gam2_all_summer_10304, select = 1)
plot(gam2_all_summer_10304, select = 2, ylim = c(-10, 10))
plot(gam2_all_summer_10304, select = 3, ylim = c(-10, 10))
plot(gam2_all_summer_10304, select = 4, ylim = c(-10, 10))
plot(gam2_all_summer_10304, select = 5, ylim = c(-10, 15))
plot(gam2_all_summer_10304, select = 6)
plot(gam2_all_summer_10304, select = 7, ylim = c(-40, 40))
plot(gam2_all_summer_10304, select = 8, ylim = c(-40, 40))
plot(gam2_all_summer_10304, select = 9, ylim = c(-40, 40))
plot(gam2_all_summer_10304, select = 10, ylim = c(-100, 20))

plot(gam2_all_summer_10304, select = 1, se = FALSE)
plot(gam2_all_summer_10304, select = 2, se = FALSE, ylim = c(-10, 10))
plot(gam2_all_summer_10304, select = 3, se = FALSE, ylim = c(-10, 10))
plot(gam2_all_summer_10304, select = 4, se = FALSE, ylim = c(-10, 10))
plot(gam2_all_summer_10304, select = 5, se = FALSE, ylim = c(-40, 40))
plot(gam2_all_summer_10304, select = 6, se = FALSE)
plot(gam2_all_summer_10304, select = 7, se = FALSE, ylim = c(-40, 40))
plot(gam2_all_summer_10304, select = 8, se = FALSE, ylim = c(-40, 40))
plot(gam2_all_summer_10304, select = 9, se = FALSE, ylim = c(-40, 40))
plot(gam2_all_summer_10304, select = 10, se = FALSE)

# GAM: all possible drivers (avg_snowstorage, avg_infiltration, max_precip, avg_snowstorage_drain linear)
gam_all_summer_10304 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + avg_snowstorage + s(groundwaterdepth, bs = "ps") + avg_infiltration + max_precip + avg_snowstorage_drain, family = binomial(), data = hydro_summer_10304_kbe, method = "REML")
summary(gam_all_summer_10304)
AIC(gam_all_summer_10304)
concurvity(gam_all_summer_10304)
plot(gam_all_summer_10304, select = 1)
plot(gam_all_summer_10304, select = 2, ylim = c(-10, 10))
plot(gam_all_summer_10304, select = 3, ylim = c(-10, 10))
plot(gam_all_summer_10304, select = 4, ylim = c(-10, 10))
plot(gam_all_summer_10304, select = 5, ylim = c(-40, 40))
plot(gam_all_summer_10304, select = 6, ylim = c(-40, 40))


# Prädiktionen bei anderen membern
# alle anderen member
plot(x = exp(predict(gam_all_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))/(1 + exp(predict(gam_all_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))), y = as.logical(hydro_summer_10304[hydro_summer_10304$member != "kbe", ]$lowlevel), col = alpha("black", 0.005))
gam_all_summer_10304_pred_error <- sum((exp(predict(gam_all_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))/(1 + exp(predict(gam_all_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))) - (as.numeric(hydro_summer_10304[hydro_summer_10304$member != "kbe", ]$lowlevel) - 1))^2, na.rm = TRUE)
```

```{r}
# GAM: all possible drivers with interactions
gam_all_interac_summer_10304 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_snowstorage_drain, bs = "ps") + s(groundwaterdepth, bs = "ps", by = avg_soilwater) + s(avg_glorad, bs = "ps", by = avg_soilwater), family = binomial(), data = hydro_summer_10304_kbe, method = "REML")
summary(gam_all_interac_summer_10304)
AIC(gam_all_interac_summer_10304)
plot(gam_all_interac_summer_10304, select = 1)
plot(gam_all_interac_summer_10304, select = 2, ylim = c(-20, 20))
plot(gam_all_interac_summer_10304, select = 3, ylim = c(-20, 20))
plot(gam_all_interac_summer_10304, select = 4, ylim = c(-20, 20))
plot(gam_all_interac_summer_10304, select = 5, ylim = c(-20, 20))
plot(gam_all_interac_summer_10304, select = 6)
plot(gam_all_interac_summer_10304, select = 7, ylim = c(-20, 20))
plot(gam_all_interac_summer_10304, select = 8, ylim = c(-80, 80))
plot(gam_all_interac_summer_10304, select = 9, ylim = c(-20, 20))
plot(gam_all_interac_summer_10304, select = 10)
plot(gam_all_interac_summer_10304, select = 11, ylim = c(-20, 20))
plot(gam_all_interac_summer_10304, select = 12, ylim = c(-20, 20))
# Prädiktionen bei anderen membern
# alle anderen member
plot(x = exp(predict(gam_all_interac_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))/(1 + exp(predict(gam_all_interac_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))), y = as.logical(hydro_summer_10304[hydro_summer_10304$member != "kbe", ]$lowlevel), col = alpha("black", 0.005))
gam_all_interac_summer_10304_pred_error <- sum((exp(predict(gam_all_interac_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))/(1 + exp(predict(gam_all_interac_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))) - (as.numeric(hydro_summer_10304[hydro_summer_10304$member != "kbe", ]$lowlevel) - 1))^2, na.rm = TRUE)




gam2_all_interac_summer_10304 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_snowstorage_drain, bs = "ps") + s(groundwaterdepth, bs = "ps", by = avg_soilwater) + s(avg_airtmp, bs = "ps", by = avg_snowstorage_drain), family = binomial(), data = hydro_summer_10304_kbe, method = "REML")
summary(gam2_all_interac_summer_10304)
AIC(gam2_all_interac_summer_10304)
plot(gam2_all_interac_summer_10304, select = 1)
plot(gam2_all_interac_summer_10304, select = 2, ylim = c(-20, 20))
plot(gam2_all_interac_summer_10304, select = 3, ylim = c(-20, 20))
plot(gam2_all_interac_summer_10304, select = 4, ylim = c(-20, 20))
plot(gam2_all_interac_summer_10304, select = 5, ylim = c(-20, 20))
plot(gam2_all_interac_summer_10304, select = 6)
plot(gam2_all_interac_summer_10304, select = 7, ylim = c(-20, 20))
plot(gam2_all_interac_summer_10304, select = 8, ylim = c(-80, 80))
plot(gam2_all_interac_summer_10304, select = 9, ylim = c(-20, 20))
plot(gam2_all_interac_summer_10304, select = 10)
plot(gam2_all_interac_summer_10304, select = 11, ylim = c(-80, 80))
plot(gam2_all_interac_summer_10304, select = 12)
# Prädiktionen bei anderen membern
# alle anderen member
plot(x = exp(predict(gam2_all_interac_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))/(1 + exp(predict(gam2_all_interac_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))), y = as.logical(hydro_summer_10304[hydro_summer_10304$member != "kbe", ]$lowlevel), col = alpha("black", 0.005))
gam2_all_interac_summer_10304_pred_error <- sum((exp(predict(gam2_all_interac_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))/(1 + exp(predict(gam2_all_interac_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))) - (as.numeric(hydro_summer_10304[hydro_summer_10304$member != "kbe", ]$lowlevel) - 1))^2, na.rm = TRUE)




gam3_all_interac_summer_10304 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_snowstorage_drain, bs = "ps") + s(groundwaterdepth, bs = "ps", by = avg_soilwater) + s(avg_airtmp, bs = "ps", by = avg_glorad), family = binomial(), data = hydro_summer_10304_kbe, method = "REML")
summary(gam3_all_interac_summer_10304)
AIC(gam3_all_interac_summer_10304)
plot(gam3_all_interac_summer_10304, select = 1)
plot(gam3_all_interac_summer_10304, select = 2, ylim = c(-80, 80))
plot(gam3_all_interac_summer_10304, select = 3, ylim = c(-5, 5))
plot(gam3_all_interac_summer_10304, select = 4, ylim = c(-20, 20))
plot(gam3_all_interac_summer_10304, select = 5, ylim = c(-20, 20))
plot(gam3_all_interac_summer_10304, select = 6)
plot(gam3_all_interac_summer_10304, select = 7, ylim = c(-20, 20))
plot(gam3_all_interac_summer_10304, select = 8, ylim = c(-80, 80))
plot(gam3_all_interac_summer_10304, select = 9, ylim = c(-20, 20))
plot(gam3_all_interac_summer_10304, select = 10)
plot(gam3_all_interac_summer_10304, select = 11, ylim = c(-80, 80))
plot(gam3_all_interac_summer_10304, select = 12, ylim = c(-5, 5))
# Prädiktionen bei anderen membern
# alle anderen member
plot(x = exp(predict(gam3_all_interac_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))/(1 + exp(predict(gam3_all_interac_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))), y = as.logical(hydro_summer_10304[hydro_summer_10304$member != "kbe", ]$lowlevel), col = alpha("black", 0.005))
gam3_all_interac_summer_10304_pred_error <- sum((exp(predict(gam3_all_interac_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))/(1 + exp(predict(gam3_all_interac_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))) - (as.numeric(hydro_summer_10304[hydro_summer_10304$member != "kbe", ]$lowlevel) - 1))^2, na.rm = TRUE)

```

# GAM: selected variables
```{r}
# avg_snowstorage, avg_infiltration, max_precip, avg_snowstorage_drain linear
# alleinige Devianzerklärungskraft von max_precip sehr gering 
gam_selected_summer_10304 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + avg_snowstorage + s(groundwaterdepth, bs = "ps") + avg_infiltration + avg_snowstorage_drain, family = binomial(), data = hydro_summer_10304_kbe, method = "REML")
summary(gam_selected_summer_10304)
AIC(gam_selected_summer_10304)
concurvity(gam_selected_summer_10304)
plot(gam_selected_summer_10304, select = 1)
plot(gam_selected_summer_10304, select = 2, ylim = c(-10, 10))
plot(gam_selected_summer_10304, select = 3, ylim = c(-10, 10))
plot(gam_selected_summer_10304, select = 4, ylim = c(-40, 40))
plot(gam_selected_summer_10304, select = 5, ylim = c(-40, 40))

# Prädiktionen bei anderen membern
# alle anderen member
plot(x = exp(predict(gam_selected_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))/(1 + exp(predict(gam_selected_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))), y = as.logical(hydro_summer_10304[hydro_summer_10304$member != "kbe", ]$lowlevel), col = alpha("black", 0.005))
gam_selected_summer_10304_pred_error <- sum((exp(predict(gam_selected_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))/(1 + exp(predict(gam_selected_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))) - (as.numeric(hydro_summer_10304[hydro_summer_10304$member != "kbe", ]$lowlevel) - 1))^2, na.rm = TRUE)
```

# GAM: selected variables with interactions
```{r}
gam2_selected_interac_summer_10304 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + avg_snowstorage  + avg_infiltration + avg_snowstorage_drain + s(groundwaterdepth, bs = "ps", by = avg_soilwater) + s(avg_glorad, bs = "ps", by = avg_soilwater) , family = binomial(), data = hydro_summer_10304_kbe, method = "REML")
summary(gam2_selected_interac_summer_10304)
concurvity(gam2_selected_interac_summer_10304)
AIC(gam2_selected_interac_summer_10304)
plot(gam2_selected_interac_summer_10304, select = 1)
plot(gam2_selected_interac_summer_10304, select = 2, ylim = c(-10, 10))
plot(gam2_selected_interac_summer_10304, select = 3, ylim = c(-10, 10))
plot(gam2_selected_interac_summer_10304, select = 4, ylim = c(-10, 10))
plot(gam2_selected_interac_summer_10304, select = 5, ylim = c(-40, 40))
plot(gam2_selected_interac_summer_10304, select = 6, ylim = c(-40, 40))
plot(gam2_selected_interac_summer_10304, select = 7, ylim = c(-40, 40))

# Prädiktionen bei anderen membern
# alle anderen member
plot(x = exp(predict(gam2_selected_interac_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))/(1 + exp(predict(gam2_selected_interac_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))), y = as.logical(hydro_summer_10304[hydro_summer_10304$member != "kbe", ]$lowlevel), col = alpha("black", 0.005))
gam2_selected_interac_summer_10304_pred_error <- sum((exp(predict(gam2_selected_interac_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))/(1 + exp(predict(gam2_selected_interac_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))) - (as.numeric(hydro_summer_10304[hydro_summer_10304$member != "kbe", ]$lowlevel) - 1))^2, na.rm = TRUE)




gam_selected_interac_summer_10304 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + avg_snowstorage + avg_infiltration + avg_snowstorage_drain + s(groundwaterdepth, bs = "ps", by = avg_soilwater) + s(groundwaterdepth, bs = "ps", by = avg_glorad), family = binomial(), data = hydro_summer_10304_kbe, method = "REML")
summary(gam_selected_interac_summer_10304)
concurvity(gam_selected_interac_summer_10304)
AIC(gam_selected_interac_summer_10304)
plot(gam_selected_interac_summer_10304, select = 1)
plot(gam_selected_interac_summer_10304, select = 2, ylim = c(-10, 10))
plot(gam_selected_interac_summer_10304, select = 3, ylim = c(-10, 10))
plot(gam_selected_interac_summer_10304, select = 4, ylim = c(-10, 10))
plot(gam_selected_interac_summer_10304, select = 5, ylim = c(-40, 40))
plot(gam_selected_interac_summer_10304, select = 6, ylim = c(-40, 40))
plot(gam_selected_interac_summer_10304, select = 7, ylim = c(-10, 10))

# Prädiktionen bei anderen membern
# alle anderen member
plot(x = exp(predict(gam_selected_interac_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))/(1 + exp(predict(gam_selected_interac_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))), y = as.logical(hydro_summer_10304[hydro_summer_10304$member != "kbe", ]$lowlevel), col = alpha("black", 0.005))
gam_selected_interac_summer_10304_pred_error <- sum((exp(predict(gam_selected_interac_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))/(1 + exp(predict(gam_selected_interac_summer_10304, newdata = hydro_summer_10304[hydro_summer_10304$member != "kbe", ]))) - (as.numeric(hydro_summer_10304[hydro_summer_10304$member != "kbe", ]$lowlevel) - 1))^2, na.rm = TRUE)
```

# Modellvergleiche
```{r}
AIC(gam_all_summer_10304, gam_all_interac_summer_10304, gam2_all_interac_summer_10304, gam3_all_interac_summer_10304, gam_selected_summer_10304,  gam_selected_interac_summer_10304, gam2_selected_interac_summer_10304)
BIC(gam_all_summer_10304, gam_all_interac_summer_10304, gam2_all_interac_summer_10304, gam3_all_interac_summer_10304, gam_selected_summer_10304, gam_selected_interac_summer_10304, gam2_selected_interac_summer_10304)
```

### Sommer Modelle Speichern
```{r}
save(gam_all_summer_10304, file = "./models/10304/gam_all_summer_10304.Rdata")
save(gam_all_interac_summer_10304, file = "./models/10304/gam_all_interac_summer_10304.Rdata")
save(gam2_all_interac_summer_10304, file = "./models/10304/gam2_all_interac_summer_10304.Rdata")
save(gam3_all_interac_summer_10304, file = "./models/10304/gam3_all_interac_summer_10304.Rdata")
save(gam_selected_summer_10304, file = "./models/10304/gam_selected_summer_10304.Rdata")
save(gam_selected_interac_summer_10304, file = "./models/10304/gam_selected_interac_summer_10304.Rdata")
save(gam2_selected_interac_summer_10304, file = "./models/10304/gam2_selected_interac_summer_10304.Rdata")
```


## Winter
# GAM: full modell
```{r}
library(mgcv)
# GAM: all possible drivers
gam2_all_winter_10304 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_winter_10304_kbe, method = "REML")
summary(gam2_all_winter_10304)
AIC(gam2_all_winter_10304)
concurvity(gam2_all_winter_10304)
plot(gam2_all_winter_10304, select = 1, ylim = c(-20, 10))
plot(gam2_all_winter_10304, select = 2, ylim = c(-5, 5))
plot(gam2_all_winter_10304, select = 3, ylim = c(-10, 15))
plot(gam2_all_winter_10304, select = 4, ylim = c(-5, 5))
plot(gam2_all_winter_10304, select = 5, ylim = c(-25, 15))
plot(gam2_all_winter_10304, select = 6, ylim = c(-5, 5))
plot(gam2_all_winter_10304, select = 7, ylim = c(-40, 20))
plot(gam2_all_winter_10304, select = 8, ylim = c(-200, 100))
plot(gam2_all_winter_10304, select = 9, ylim = c(-40, 40))
plot(gam2_all_winter_10304, select = 10, ylim = c(-500, 100))

plot(gam2_all_winter_10304, select = 1, se = FALSE, ylim = c(-80, 80))
plot(gam2_all_winter_10304, select = 2, se = FALSE, ylim = c(-5, 5))
plot(gam2_all_winter_10304, select = 3, se = FALSE, ylim = c(-80, 80))
plot(gam2_all_winter_10304, select = 4, se = FALSE, ylim = c(-5, 5))
plot(gam2_all_winter_10304, select = 5, se = FALSE, ylim = c(-80, 80))
plot(gam2_all_winter_10304, select = 6, se = FALSE, ylim = c(-5, 5))
plot(gam2_all_winter_10304, select = 7, se = FALSE, ylim = c(-80, 80))
plot(gam2_all_winter_10304, select = 8, se = FALSE, ylim = c(-200, 100))
plot(gam2_all_winter_10304, select = 9, se = FALSE, ylim = c(-80, 80))
plot(gam2_all_winter_10304, select = 10, se = FALSE)


# GAM: all possible drivers (avg_airtmp, avg_infiltration linear)
gam_all_winter_10304 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + avg_airtmp + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + avg_infiltration + s(max_precip, bs = "ps") + s(avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_winter_10304_kbe, method = "REML")
summary(gam_all_winter_10304)
plot(gam_all_winter_10304, select = 1, ylim = c(-80, 80))
plot(gam_all_winter_10304, select = 2, ylim = c(-80, 80))
plot(gam_all_winter_10304, select = 3, ylim = c(-5, 5))
plot(gam_all_winter_10304, select = 4, ylim = c(-80, 80))
plot(gam_all_winter_10304, select = 5, ylim = c(-5, 5))
plot(gam_all_winter_10304, select = 6, ylim = c(-80, 80))
plot(gam_all_winter_10304, select = 7, ylim = c(-80, 80))
plot(gam_all_winter_10304, select = 8)

# Prädiktionen bei anderen membern
# alle anderen member
plot(x = exp(predict(gam_all_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))/(1 + exp(predict(gam_all_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))), y = as.logical(hydro_winter_10304[hydro_winter_10304$member != "kbe", ]$lowlevel), col = alpha("black", 0.005))
gam_all_winter_10304_pred_error <- sum((exp(predict(gam_all_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))/(1 + exp(predict(gam_all_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))) - (as.numeric(hydro_winter_10304[hydro_winter_10304$member != "kbe", ]$lowlevel) - 1))^2, na.rm = TRUE)
```

```{r}
# GAM: all possible drivers with interactions
gam_all_interac_winter_10304 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_snowstorage_drain, bs = "ps") + s(avg_snowstorage, bs = "ps", by = groundwaterdepth) + s(avg_glorad, bs = "ps", by = groundwaterdepth), family = binomial(), data = hydro_winter_10304_kbe, method = "REML")
summary(gam_all_interac_winter_10304)
AIC(gam_all_interac_winter_10304)
plot(gam_all_interac_winter_10304, select = 1, ylim = c(-100, 100))
plot(gam_all_interac_winter_10304, select = 2, ylim = c(-50, 50))
plot(gam_all_interac_winter_10304, select = 3, ylim = c(-50, 50))
plot(gam_all_interac_winter_10304, select = 4, ylim = c(-10, 10))
plot(gam_all_interac_winter_10304, select = 5, ylim = c(-50, 50))
plot(gam_all_interac_winter_10304, select = 6, ylim = c(-50, 50))
plot(gam_all_interac_winter_10304, select = 7, ylim = c(-3000, 3000))
plot(gam_all_interac_winter_10304, select = 8, ylim = c(-2000, 2000))
plot(gam_all_interac_winter_10304, select = 9, ylim = c(-100, 100))
plot(gam_all_interac_winter_10304, select = 10)
plot(gam_all_interac_winter_10304, select = 11, ylim = c(-500, 500))
plot(gam_all_interac_winter_10304, select = 12, ylim = c(-10, 10))
# Prädiktionen bei anderen membern
# alle anderen member
plot(x = exp(predict(gam_all_interac_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))/(1 + exp(predict(gam_all_interac_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))), y = as.logical(hydro_winter_10304[hydro_winter_10304$member != "kbe", ]$lowlevel), col = alpha("black", 0.005))
gam_all_interac_winter_10304_pred_error <- sum((exp(predict(gam_all_interac_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))/(1 + exp(predict(gam_all_interac_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))) - (as.numeric(hydro_winter_10304[hydro_winter_10304$member != "kbe", ]$lowlevel) - 1))^2, na.rm = TRUE)



gam2_all_interac_winter_10304 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_snowstorage_drain, bs = "ps") + s(avg_snowstorage, bs = "ps", by = groundwaterdepth) + s(avg_snowstorage, bs = "ps", by = avg_soilwater), family = binomial(), data = hydro_winter_10304_kbe, method = "REML")
summary(gam2_all_interac_winter_10304)
AIC(gam2_all_interac_winter_10304)
plot(gam2_all_interac_winter_10304, select = 1, ylim = c(-100, 100))
plot(gam2_all_interac_winter_10304, select = 2, ylim = c(-50, 50))
plot(gam2_all_interac_winter_10304, select = 3, ylim = c(-50, 50))
plot(gam2_all_interac_winter_10304, select = 4, ylim = c(-10, 10))
plot(gam2_all_interac_winter_10304, select = 5, ylim = c(-50, 50))
plot(gam2_all_interac_winter_10304, select = 6, ylim = c(-1000, 1000))
plot(gam2_all_interac_winter_10304, select = 7, ylim = c(-200, 200))
plot(gam2_all_interac_winter_10304, select = 8, ylim = c(-2000, 2000))
plot(gam2_all_interac_winter_10304, select = 9, ylim = c(-100, 100))
plot(gam2_all_interac_winter_10304, select = 10)
plot(gam2_all_interac_winter_10304, select = 11, ylim = c(-100, 100))
plot(gam2_all_interac_winter_10304, select = 12, ylim = c(-50, 50))
# Prädiktionen bei anderen membern
# alle anderen member
plot(x = exp(predict(gam2_all_interac_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))/(1 + exp(predict(gam2_all_interac_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))), y = as.logical(hydro_winter_10304[hydro_winter_10304$member != "kbe", ]$lowlevel), col = alpha("black", 0.005))
gam2_all_interac_winter_10304_pred_error <- sum((exp(predict(gam2_all_interac_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))/(1 + exp(predict(gam2_all_interac_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))) - (as.numeric(hydro_winter_10304[hydro_winter_10304$member != "kbe", ]$lowlevel) - 1))^2, na.rm = TRUE)



gam3_all_interac_winter_10304 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_snowstorage_drain, bs = "ps") + s(avg_glorad, bs = "ps", by = groundwaterdepth) + s(avg_snowstorage, bs = "ps", by = avg_glorad), family = binomial(), data = hydro_winter_10304_kbe, method = "REML")
summary(gam3_all_interac_winter_10304)
AIC(gam3_all_interac_winter_10304)
plot(gam3_all_interac_winter_10304, select = 1, ylim = c(-100, 100))
plot(gam3_all_interac_winter_10304, select = 2, ylim = c(-50, 50))
plot(gam3_all_interac_winter_10304, select = 3, ylim = c(-50, 50))
plot(gam3_all_interac_winter_10304, select = 4, ylim = c(-10, 10))
plot(gam3_all_interac_winter_10304, select = 5, ylim = c(-50, 50))
plot(gam3_all_interac_winter_10304, select = 6, ylim = c(-50, 50))
plot(gam3_all_interac_winter_10304, select = 7, ylim = c(-2000, 2000))
plot(gam3_all_interac_winter_10304, select = 8, ylim = c(-2000, 2000))
plot(gam3_all_interac_winter_10304, select = 9, ylim = c(-100, 100))
plot(gam3_all_interac_winter_10304, select = 10)
plot(gam3_all_interac_winter_10304, select = 11, ylim = c(-1000, 1000))
plot(gam3_all_interac_winter_10304, select = 12, ylim = c(-10, 10))
# Prädiktionen bei anderen membern
# alle anderen member
plot(x = exp(predict(gam3_all_interac_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))/(1 + exp(predict(gam3_all_interac_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))), y = as.logical(hydro_winter_10304[hydro_winter_10304$member != "kbe", ]$lowlevel), col = alpha("black", 0.005))
gam3_all_interac_winter_10304_pred_error <- sum((exp(predict(gam3_all_interac_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))/(1 + exp(predict(gam3_all_interac_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))) - (as.numeric(hydro_winter_10304[hydro_winter_10304$member != "kbe", ]$lowlevel) - 1))^2, na.rm = TRUE)
```

# GAM: selected variables
```{r}
# avg_infiltration linear;
# Effekte von avg_airtmp nicht signifikant; alleinige Erklärungskraft von avg_relhum und max_precip sehr gering
gam_selected_winter_10304 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + avg_airtmp + s(avg_glorad, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + avg_infiltration + s(avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_winter_10304_kbe, method = "REML")
summary(gam_selected_winter_10304)
concurvity(gam_selected_winter_10304)
AIC(gam_selected_winter_10304)
plot(gam_selected_winter_10304, select = 1, ylim = c(-80, 80))
plot(gam_selected_winter_10304, select = 2, ylim = c(-40, 40))
plot(gam_selected_winter_10304, select = 3, ylim = c(-40, 40))
plot(gam_selected_winter_10304, select = 4, ylim = c(-5, 5))
plot(gam_selected_winter_10304, select = 5, ylim = c(-80, 80))
plot(gam_selected_winter_10304, select = 6)

# Prädiktionen bei anderen membern
# alle anderen member
plot(x = exp(predict(gam_selected_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))/(1 + exp(predict(gam_selected_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))), y = as.logical(hydro_winter_10304[hydro_winter_10304$member != "kbe", ]$lowlevel), col = alpha("black", 0.005))
gam_selected_winter_10304_pred_error <- sum((exp(predict(gam_selected_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))/(1 + exp(predict(gam_selected_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))) - (as.numeric(hydro_winter_10304[hydro_winter_10304$member != "kbe", ]$lowlevel) - 1))^2, na.rm = TRUE)
```

# GAM: selected variables with interactions
```{r}
gam_selected_interac_winter_10304 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + avg_airtmp + s(avg_soilwater, bs = "ps") + avg_infiltration + s(avg_snowstorage_drain, bs = "ps") + s(avg_snowstorage, bs = "ps", by = groundwaterdepth) + s(avg_glorad, bs = "ps", by = groundwaterdepth), family = binomial(), data = hydro_winter_10304_kbe, method = "REML")

summary(gam_selected_interac_winter_10304)
AIC(gam_selected_interac_winter_10304)

gam2_selected_interac_winter_10304 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + avg_airtmp + s(avg_soilwater, bs = "ps") + avg_infiltration + s(avg_snowstorage_drain, bs = "ps") +  s(avg_snowstorage, bs = "ps", by = groundwaterdepth) + s(avg_snowstorage, bs = "ps", by = avg_glorad), family = binomial(), data = hydro_winter_10304_kbe, method = "REML")

summary(gam2_selected_interac_winter_10304)
AIC(gam2_selected_interac_winter_10304)
plot(gam2_selected_interac_winter_10304, select = 1, ylim = c(-80, 80))
plot(gam2_selected_interac_winter_10304, select = 2, ylim = c(-40, 40))
plot(gam2_selected_interac_winter_10304, select = 3, ylim = c(-80, 80))
plot(gam2_selected_interac_winter_10304, select = 4)
plot(gam2_selected_interac_winter_10304, select = 5)
plot(gam2_selected_interac_winter_10304, select = 6)
plot(gam2_selected_interac_winter_10304, select = 7, ylim = c(-500, 500))
plot(gam2_selected_interac_winter_10304, select = 8, ylim = c(-1, 1))

# Prädiktionen bei anderen membern
# alle anderen member
plot(x = exp(predict(gam2_selected_interac_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))/(1 + exp(predict(gam2_selected_interac_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))), y = as.logical(hydro_winter_10304[hydro_winter_10304$member != "kbe", ]$lowlevel), col = alpha("black", 0.005))
gam2_selected_interac_winter_10304_pred_error <- sum((exp(predict(gam2_selected_interac_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))/(1 + exp(predict(gam2_selected_interac_winter_10304, newdata = hydro_winter_10304[hydro_winter_10304$member != "kbe", ]))) - (as.numeric(hydro_winter_10304[hydro_winter_10304$member != "kbe", ]$lowlevel) - 1))^2, na.rm = TRUE)
```
# Modellvergleiche
```{r}
AIC(gam_all_winter_10304, gam_all_interac_winter_10304, gam2_all_interac_winter_10304, gam3_all_interac_winter_10304, gam_selected_winter_10304, gam_selected_interac_winter_10304, gam2_selected_interac_winter_10304)
BIC(gam_all_winter_10304, gam_all_interac_winter_10304, gam2_all_interac_winter_10304, gam3_all_interac_winter_10304, gam_selected_winter_10304, gam_selected_interac_winter_10304, gam2_selected_interac_winter_10304)

```

### Winter Modelle Speichern
```{r}
save(gam_all_winter_10304, file = "./models/10304/gam_all_winter_10304.Rdata")
save(gam_all_interac_winter_10304, file = "./models/10304/gam_all_interac_winter_10304.Rdata")
save(gam2_all_interac_winter_10304, file = "./models/10304/gam2_all_interac_winter_10304.Rdata")
save(gam3_all_interac_winter_10304, file = "./models/10304/gam3_all_interac_winter_10304.Rdata")
save(gam_selected_winter_10304, file = "./models/10304/gam_selected_winter_10304.Rdata")
save(gam_selected_interac_winter_10304, file = "./models/10304/gam_selected_interac_winter_10304.Rdata")
save(gam2_selected_interac_winter_10304, file = "./models/10304/gam2_selected_interac_winter_10304.Rdata")
```




# Iller Kempten
```{r}
hydro_summer_11502_kbe <- hydro_summer %>% filter(member %in% "kbe") %>% filter(name_waterlevel %in% "11502")

hydro_winter_11502_kbe <- hydro_winter %>% filter(member %in% "kbe") %>% filter(name_waterlevel %in% "11502")
```
## Sommer
```{r}
# GLM: all possible drivers
glm_all_summer_11502 <- glm(formula = lowlevel ~ YY + avg_precip + avg_airtmp + avg_glorad + avg_relhum + avg_soilwater + avg_snowstorage + groundwaterdepth + avg_infiltration + max_precip + avg_snowstorage_drain, family = binomial(), data = hydro_summer_11502_kbe)
summary(glm_all_summer_11502)

# GLM: AIC variable selection
library(MASS)
stepAIC(glm_all_summer_11502, direction = "both")
# Variablen YY, avg_precip, avg_airtmp, avg_glorad, avg_relhum, avg_soilwater, avg_snowstorage, groundwaterdepth, max_precip, avg_snowstorage_drain ausgewählt

# GAM: only selected drivers
library(mgcv)
gam_selected_summer_11502 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(max_precip, bs = "ps") + s(avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_winter_11502_kbe, method = "REML")
summary(gam_selected_summer_11502)
plot(gam_selected_summer_11502)
```

## Winter
```{r}
# GLM: all possible drivers
glm_all_winter_11502 <- glm(formula = lowlevel ~ YY + avg_precip + avg_airtmp + avg_glorad + avg_relhum + avg_soilwater + avg_snowstorage + groundwaterdepth + avg_infiltration + max_precip + avg_snowstorage_drain, family = binomial(), data = hydro_winter_11502_kbe)
summary(glm_all_winter_11502)

# GLM: AIC variable selection
library(MASS)
stepAIC(glm_all_winter_11502, direction = "both")
# Variablen YY, avg_precip, avg_airtmp, avg_glorad, avg_relhum, avg_soilwater, avg_snowstorage, groundwaterdepth, avg_infiltration, avg_snowstorage_drain ausgewählt

# GAM: only selected drivers
library(mgcv)
gam_selected_winter_11502 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_winter_11502_kbe, method = "REML")
summary(gam_selected_winter_11502)
plot(gam_selected_winter_11502)
```

### GLM and AIC stepwise
```{r}
glm_all_summer_11502 <- glm(formula = lowlevel ~ YY + avg_precip + avg_airtmp+ avg_glorad + avg_relhum + avg_soilwater + avg_snowstorage + groundwaterdepth + avg_infiltration + max_precip_scaled, family = binomial(), data = hydro_summer_11502_kbe)

MASS::stepAIC(object = glm_all_summer_11502, direction = "both",
k = 2, trace = FALSE)
```
### GAM
```{r}
gam1_summer_11502 <- gam(formula = lowlevel ~ YY + avg_airtmp + avg_glorad + avg_relhum + avg_soilwater + avg_snowstorage + groundwaterdepth + avg_infiltration + max_precip_scaled, data = hydro_summer_11502_kbe, family = binomial(), method = "REML")

gam2_summer_11502 <- gam(formula = lowlevel ~ YY + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip_scaled, bs = "ps"), data = hydro_summer_11502_kbe, family = binomial(), method = "REML")

gam3_summer_11502 <- gam(formula = lowlevel ~ YY + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip_scaled, bs = "ps") + s(avg_snowstorage, by = avg_airtmp, bs = "ps"), data = hydro_summer_11502_kbe, family = binomial(), method = "REML")

gam4_summer_11502 <- gam(formula = lowlevel ~ YY + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(avg_snowstorage, by = max_precip_scaled, bs = "ps") , data = hydro_summer_11502_kbe, family = binomial(), method = "REML")

gam5_summer_11502 <- gam(formula = lowlevel ~ YY + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip_scaled, by = avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps", by = avg_airtmp), data = hydro_summer_11502_kbe, family = binomial(), method = "REML")
```

```{r}
summary(gam1_summer_11502)
summary(gam2_summer_11502)
summary(gam3_summer_11502)
summary(gam4_summer_11502)
summary(gam5_summer_11502)
```


## Winter
### Glm and AIC stepwise
```{r}
glm_all_winter_11502 <- glm(formula = lowlevel ~ YY + avg_precip + avg_airtmp+ avg_glorad + avg_relhum + avg_soilwater + avg_snowstorage + groundwaterdepth + avg_infiltration + max_precip_scaled, family = binomial(), data = hydro_winter_11502_kbe)

MASS::stepAIC(object = glm_all_winter_11502, direction = "both",
k = 2, trace = FALSE)
```

### GAM
```{r}
gam1_winter_11502 <- gam(formula = lowlevel ~ avg_precip + avg_glorad + avg_soilwater + avg_snowstorage + groundwaterdepth + avg_infiltration + max_precip_scaled, data = hydro_winter_11502_kbe, family = binomial(), method = "REML")

gam2_winter_11502 <- gam(formula = lowlevel ~ s(avg_precip, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip_scaled, bs = "ps"), data = hydro_winter_11502_kbe, family = binomial(), method = "REML")

gam3_winter_11502 <- gam(formula = lowlevel ~ s(avg_precip, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(avg_precip, bs = "ps", by = avg_soilwater), data = hydro_winter_11502_kbe, family = binomial(), method = "REML")

gam4_winter_11502 <- gam(formula = lowlevel ~ s(avg_precip, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(avg_precip, bs = "ps", by = avg_soilwater) + s(avg_airtmp, bs = "ps", by = avg_snowstorage), data = hydro_winter_11502_kbe, family = binomial(), method = "REML")

gam5_winter_11502 <- gam(formula = lowlevel ~ s(avg_precip, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(avg_precip, bs = "ps", by = avg_soilwater) + s(avg_snowstorage, bs = "ps", by = avg_airtmp) + s(avg_airtmp, bs = "ps"), data = hydro_winter_11502_kbe, family = binomial(), method = "REML")
```

```{r}
summary(gam1_winter_11502)
summary(gam2_winter_11502)
summary(gam3_winter_11502)
summary(gam4_winter_11502)
summary(gam5_winter_11502)
```
### Winter effect plots
```{r}

# jpeg("./Plots/Max/effects_gam2_winter_11502.jpg", width = 700, height = 600)
layout(matrix(1:9, ncol = 3, nrow = 3))
plot(gam2_winter_11502, select = 1, ylim = c(-50, 20))
plot(gam2_winter_11502, select = 2, ylim = c(-20, 20))
plot(gam2_winter_11502, select = 3, ylim = c(-30,30))
plot(gam2_winter_11502, select = 4, ylim = c(-600, 100))
plot(gam2_winter_11502, select = 5, ylim = c(-50, 20))
plot(gam2_winter_11502, select = 6, ylim = c(-100, 20))
plot(gam2_winter_11502, select = 7, ylim = c(-20, 10))
# dev.off()

# jpeg("./Plots/Max/effects_gam3_winter_11502.jpg", width = 700, height = 600)
layout(matrix(1:9, ncol = 3, nrow = 3))
plot(gam3_winter_11502, select = 1, ylim = c(-50, 20))
plot(gam3_winter_11502, select = 2, ylim = c(-20, 20))
plot(gam3_winter_11502, select = 3, ylim = c(-30,30))
plot(gam3_winter_11502, select = 4, ylim = c(-600, 100))
plot(gam3_winter_11502, select = 5, ylim = c(-50, 20))
plot(gam3_winter_11502, select = 6, ylim = c(-100, 20))
plot(gam3_winter_11502, select = 7, ylim = c(-20, 50))
# dev.off()

# jpeg("./Plots/Max/effects_gam4_winter_11502.jpg", width = 700, height = 600)
layout(matrix(1:9, ncol = 3, nrow = 3))
plot(gam4_winter_11502, select = 1, ylim = c(-50, 20))
plot(gam4_winter_11502, select = 2, ylim = c(-20, 20))
plot(gam4_winter_11502, select = 3, ylim = c(-30,30))
plot(gam4_winter_11502, select = 4, ylim = c(-600, 100))
plot(gam4_winter_11502, select = 5, ylim = c(-50, 20))
plot(gam4_winter_11502, select = 6, ylim = c(-100, 20))
plot(gam4_winter_11502, select = 7, ylim = c(-20, 50))
plot(gam4_winter_11502, select = 8, ylim = c(-10, 10))
# dev.off()

# jpeg("./Plots/Max/effects_gam5_winter_11502.jpg", width = 700, height = 600)
layout(matrix(1:9, ncol = 3, nrow = 3))
plot(gam5_winter_11502, select = 1, ylim = c(-50, 20))
plot(gam5_winter_11502, select = 2, ylim = c(-20, 20))
plot(gam5_winter_11502, select = 3, ylim = c(-30,30))
plot(gam5_winter_11502, select = 4, ylim = c(-600, 100))
plot(gam5_winter_11502, select = 5, ylim = c(-50, 20))
plot(gam5_winter_11502, select = 6, ylim = c(-100, 20))
plot(gam5_winter_11502, select = 7, ylim = c(-20, 50))
plot(gam5_winter_11502, select = 8, ylim = c(-10, 10))
plot(gam5_winter_11502, select = 9, ylim = c(-10, 10))
# dev.off()
```


### Summer Effect Plots 
```{r}
# jpeg("./Plots/Max/effects_gam2_summer_11502.jpg", width = 700, height = 600)
layout(matrix(1:9, ncol = 3, nrow = 3))
plot(gam2_summer_11502, select = 1, ylim = c(-10, 20))
plot(gam2_summer_11502, select = 2, ylim = c(-10, 10))
plot(gam2_summer_11502, select = 3, ylim = c(-20,20))
plot(gam2_summer_11502, select = 4, ylim = c(-30, 10))
plot(gam2_summer_11502, select = 5, ylim = c(- 1000, 100))
plot(gam2_summer_11502, select = 6, ylim = c(-20, 20))
plot(gam2_summer_11502, select = 7, ylim = c(-100, 20))
# dev.off()

# jpeg("./Plots/Max/effects_gam3_summer_11502.jpg", width = 700, height = 600)
layout(matrix(1:9, ncol = 3, nrow = 3))
plot(gam3_summer_11502, select = 1, ylim = c(-10, 20))
plot(gam3_summer_11502, select = 2, ylim = c(-10, 10))
plot(gam3_summer_11502, select = 3, ylim = c(-20,20))
plot(gam3_summer_11502, select = 4, ylim = c(-30, 10))
plot(gam3_summer_11502, select = 5, ylim = c(- 2000, 2000))
plot(gam3_summer_11502, select = 6, ylim = c(-20, 20))
plot(gam3_summer_11502, select = 7, ylim = c(-100, 20))
plot(gam3_summer_11502, select = 8, ylim = c(-20, 20))
plot(gam3_summer_11502, select = 9, ylim = c(-200, 100))
# dev.off()


# jpeg("./Plots/Max/effects_gam4_summer_11502.jpg", width = 700, height = 600)
layout(matrix(1:9, ncol = 3, nrow = 3))
plot(gam4_summer_11502, select = 1, ylim = c(-10, 20))
plot(gam4_summer_11502, select = 2, ylim = c(-10, 10))
plot(gam4_summer_11502, select = 3, ylim = c(-20,20))
plot(gam4_summer_11502, select = 4, ylim = c(-30, 10))
plot(gam4_summer_11502, select = 5, ylim = c(- 2000, 2000))
plot(gam4_summer_11502, select = 6, ylim = c(-20, 20))
plot(gam4_summer_11502, select = 7, ylim = c(-100, 20))
plot(gam4_summer_11502, select = 8, ylim = c(-20, 20))
plot(gam4_summer_11502, select = 9, ylim = c(-200, 100))
# dev.off()

# jpeg("./Plots/Max/effects_gam5_summer_11502.jpg", width = 700, height = 600)
layout(matrix(1:9, ncol = 3, nrow = 3))
plot(gam5_summer_11502, select = 1, ylim = c(-10, 20))
plot(gam5_summer_11502, select = 2, ylim = c(-10, 10))
plot(gam5_summer_11502, select = 3, ylim = c(-20,20))
plot(gam5_summer_11502, select = 4, ylim = c(-30, 10))
plot(gam5_summer_11502, select = 5, ylim = c(- 2000, 2000))
plot(gam5_summer_11502, select = 6, ylim = c(-20, 20))
plot(gam5_summer_11502, select = 7, ylim = c(-100, 20))
plot(gam5_summer_11502, select = 8, ylim = c(-10, 10))
plot(gam5_summer_11502, select = 9, ylim = c(-200, 100))
#dev.off()
```
# Revised
## Winter
### All
```{r}
gam_all_winter_11502 <- gam(formula = lowlevel ~ YY + avg_precip + s(avg_airtmp, bs = "ps") + avg_glorad + avg_relhum + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + max_precip + s(avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_winter_11502_kbe, method = "REML")
summary(gam_all_winter_11502)
```
#### Viz
```{r}
plot(gam_all_winter_11502, select = 1, ylim = c(-50, 50))
plot(gam_all_winter_11502, select = 2, ylim = c(-10, 10))
plot(gam_all_winter_11502, select = 3, ylim = c(-10, 10))
plot(gam_all_winter_11502, select = 4, ylim = c(-10, 10))
plot(gam_all_winter_11502, select = 5, ylim = c(-20, 20))
plot(gam_all_winter_11502, select = 6, ylim = c(-400, 50))
plot(gam_all_winter_11502, select = 7, ylim = c(-40, 20))
plot(gam_all_winter_11502, select = 8, ylim = c(-100, 50))
plot(gam_all_winter_11502, select = 9, ylim = c(-20,20))
```

### Trimed
```{r}
gam_trimmed_winter_11502 <- gam(formula = lowlevel ~ YY + avg_precip + s(avg_airtmp, bs = "ps") + avg_glorad + avg_relhum + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps")  + s(avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_winter_11502_kbe, method = "REML")
summary(gam_trimmed_winter_11502)
```
#### Viz
```{r}
plot(gam_trimmed_winter_11502, select = 1, ylim = c(-50, 50))
plot(gam_trimmed_winter_11502, select = 2, ylim = c(-10, 10))
plot(gam_trimmed_winter_11502, select = 3, ylim = c(-10, 10))
plot(gam_trimmed_winter_11502, select = 4, ylim = c(-10, 10))
plot(gam_trimmed_winter_11502, select = 5, ylim = c(-20, 20))
plot(gam_trimmed_winter_11502, select = 6, ylim = c(-400, 50))
plot(gam_trimmed_winter_11502, select = 7, ylim = c(-40, 20))
plot(gam_trimmed_winter_11502, select = 8, ylim = c(-100, 50))
plot(gam_trimmed_winter_11502, select = 9, ylim = c(-20,20))
```
### Interactions
```{r}
gam_interactions_winter_11502 <- gam(formula = lowlevel ~ YY + avg_precip + + s(avg_glorad, bs = "ps") + avg_relhum + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps")  + s(avg_snowstorage_drain, bs = "ps") + s(avg_precip, bs = "ps", by = avg_soilwater) + s(avg_snowstorage, bs = "ps", by = avg_airtmp), family = binomial(), data = hydro_winter_11502_kbe, method = "REML")
summary(gam_interactions_winter_11502)
```


# Summer
## All
```{r}
gam_all_summer_11502 <- gam(formula = lowlevel ~ YY + avg_precip + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + avg_snowstorage + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + avg_snowstorage_drain, family = binomial(), data = hydro_summer_11502_kbe, method = "REML")
summary(gam_all_summer_11502)
```
##Trimmed
```{r}
gam_trimmed_summer_11502 <- gam(formula = lowlevel ~ YY + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + avg_snowstorage + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + avg_snowstorage_drain, family = binomial(), data = hydro_summer_11502_kbe, method = "REML")
summary(gam_trimmed_summer_11502)
```
### Viz
```{r}
plot(gam_trimmed_summer_11502, select = 1, ylim = c(-200, 50))
plot(gam_trimmed_summer_11502, select = 2, ylim = c(-10, 10))
plot(gam_trimmed_summer_11502, select = 3, ylim = c(-15, 15))
plot(gam_trimmed_summer_11502, select = 4, ylim = c(-15, 15))
plot(gam_trimmed_summer_11502, select = 5 )
plot(gam_trimmed_summer_11502, select = 6, ylim = c(-40, 40))
plot(gam_trimmed_summer_11502, select = 7, ylim = c(-50, 50))
plot(gam_trimmed_summer_11502, select = 8, ylim = c(-20, 20))
```
### Interactions
```{r}
gam_interactions_summer_11502 <- gam(formula = lowlevel ~ YY + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + avg_snowstorage + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + max_precip + avg_snowstorage_drain + s(max_precip, by = avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps", by = avg_airtmp), family = binomial(), data = hydro_summer_11502_kbe, method = "REML")
summary(gam_interactions_summer_11502)
```

## AIC Comparison
### Winter
```{r}
gam_all_winter_11502$aic
gam_trimmed_winter_11502$aic
gam_interactions_winter_11502$aic
```

### Summer
```{r}
gam_all_summer_11502$aic
gam_trimmed_summer_11502$aic
gam_interactions_summer_11502$aic


plot(gam_interactions_summer_11502, select = 8, ylim = c(-20,20))
```
# Save models for Shiny
```{r}
save(gam_all_summer_11502, file = "models/gam_all_summer_11502.Rdata")
save(gam_trimmed_summer_11502, file = "models/gam_trimmed_summer_11502.Rdata")
save(gam_interactions_summer_11502, file = "models/gam_interactions_summer_11502.Rdata")

save(gam_all_winter_11502, file = "models/gam_all_winter_11502.Rdata")
save(gam_trimmed_winter_11502, file = "models/gam_trimmed_winter_11502.Rdata")
save(gam_interactions_winter_11502, file = "models/gam_interactions_winter_11502.Rdata")
```


# Random Forest
```{r}
rf_summer_11502 <- randomForest::randomForest(lowlevel ~ YY + avg_precip + avg_airtmp+ avg_glorad + avg_relhum + avg_soilwater + avg_snowstorage + groundwaterdepth + avg_infiltration + max_precip_scaled, data= hydro_summer_11502_kbe, proximity=TRUE, na.action = na.omit, importance = TRUE)

rf_winter_11502 <- randomForest::randomForest(lowlevel ~ YY + avg_precip + avg_airtmp+ avg_glorad + avg_relhum + avg_soilwater + avg_snowstorage + groundwaterdepth + avg_infiltration + max_precip_scaled, data= hydro_summer_11502_kbe, proximity=TRUE, na.action = na.omit, importance = TRUE)


rfPermute::plotImportance(rf_summer_11502)
rfPermute::plotImportance(rf_winter_11502)
```

# Volle Modelle für alle Pegel und Halbjahre
```{r}
gam2_all_winter_10304 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_winter_10304_kbe, method = "REML")
summary(gam2_all_winter_10304)
AIC(gam2_all_winter_10304)

gam2_all_summer_10304 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_summer_10304_kbe, method = "REML")
summary(gam2_all_summer_10304)
AIC(gam2_all_summer_10304)

gam_all_winter_11502 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_winter_11502_kbe, method = "REML")
summary(gam_all_winter_11502)
AIC(gam_all_winter_11502)

gam_all_summer_11502 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_summer_11502_kbe, method = "REML")
summary(gam_all_summer_11502)
AIC(gam_all_summer_11502)


gam_all_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")
summary(gam_all_winter_20203)
AIC(gam_all_winter_20203)


gam_all_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(max_precip, bs = "ps") + s(avg_snowstorage_drain, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")
summary(gam_all_summer_20203)
AIC(gam_all_summer_20203)




```

# Selektierte Modelle für alle Pregel und Halbjahre
## 1
```{r}
# nur Treiber: avg_precip, avg_airtmp, avg_glorad, avg_soilwater, avg_snowstorage, groundwaterdepth um Multikollinearität zu vermeiden (in keinem der 6 Datensätze eine Korrelation von > 0.8 bzw. <-0.8)
gam_uni_selected_winter_10304 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps"), family = binomial(), data = hydro_winter_10304_kbe, method = "REML")
summary(gam_uni_selected_winter_10304)
AIC(gam_uni_selected_winter_10304)
BIC(gam_uni_selected_winter_10304)
concurvity(gam_uni_selected_winter_10304)
#plot(gam_uni_selected_winter_10304, ylim = c(-7, 7))


gam_uni_selected_summer_10304 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps"), family = binomial(), data = hydro_summer_10304_kbe, method = "REML")
summary(gam_uni_selected_summer_10304)
AIC(gam_uni_selected_summer_10304)
BIC(gam_uni_selected_summer_10304)
concurvity(gam_uni_selected_summer_10304)
#plot(gam_uni_selected_summer_10304, ylim = c(-7, 7))


gam_uni_selected_winter_11502 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps"), family = binomial(), data = hydro_winter_11502_kbe, method = "REML")
summary(gam_uni_selected_winter_11502)
AIC(gam_uni_selected_winter_11502)
BIC(gam_uni_selected_winter_11502)
concurvity(gam_uni_selected_winter_11502)
#plot(gam_uni_selected_winter_11502, ylim = c(-7, 7))


gam_uni_selected_summer_11502 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps"), family = binomial(), data = hydro_summer_11502_kbe, method = "REML")
summary(gam_uni_selected_summer_11502)
AIC(gam_uni_selected_summer_11502)
BIC(gam_uni_selected_summer_11502)
concurvity(gam_uni_selected_summer_11502)
#plot(gam_uni_selected_summer_11502, ylim = c(-7, 7))


gam_uni_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")
summary(gam_uni_selected_winter_20203)
AIC(gam_uni_selected_winter_20203)
BIC(gam_uni_selected_winter_20203)
concurvity(gam_uni_selected_winter_20203)
#plot(gam_uni_selected_winter_20203, ylim = c(-7, 7))


gam_uni_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")
summary(gam_uni_selected_summer_20203)
AIC(gam_uni_selected_summer_20203)
BIC(gam_uni_selected_summer_20203)
concurvity(gam_uni_selected_summer_20203)
#plot(gam_uni_selected_summer_20203, ylim = c(-7, 7))
```
# Effect Plots

```{r}
# Isar Winter
# Soilwater
jpeg("./Plots/Max/soilwater_winter_isar.jpeg", width = 750, height = 620)
plot(gam_uni_selected_winter_10304, ylim = c(-7, 7), xlim = c(-6,6), xlab = "Rolling mean oberflächennahe rel. Bodenfeuchte \n (letzte 60 Tage; zentriert, skaliert)", select = 4, main = "Isar Mittenwald \n Effekt der mittleren oberfl. rel. Bodenfeuchte", ylab = "log. Odds")
dev.off()
# Glorad
jpeg("./Plots/Max/glorad_winter_isar.jpeg", width = 750, height = 620)
plot(gam_uni_selected_winter_10304, ylim = c(-7, 7), xlim = c(-250, 600), xlab = "Rolling mean einfallende kurzwellige Strahlung \n (letzte 7 Tage; zentriert)", select = 3, main = "Isar Mittenwald \n Effekt der mittleren einfallenden kurzwelligen Strahlung", ylab = "log. Odds")
dev.off()
# Lufttemperatur
jpeg("./Plots/Max/airtmp_winter_isar.jpeg", width = 750, height = 620)
plot(gam_uni_selected_winter_10304, ylim = c(-7, 7), xlim = c(-15, 15), xlab = "Rolling mean Lufttemperatur \n (letzte 7 Tage; zentriert)", select = 2, main = "Isar Mittenwald \n Effekt der mittleren Lufttemperatur", ylab = "log. Odds")
dev.off()

# Saale Winter

# Soilwater
jpeg("./Plots/Max/soilwater_winter_saale.jpeg", width = 750, height = 620)
plot(gam_uni_selected_winter_20203, ylim = c(-7, 7), xlim = c(-6, 6), xlab = "Rolling mean oberflächennahe rel. Bodenfeuchte \n (letzte 60 Tage; zentriert, skaliert)", select = 4, main = "Fränkische Saale Salz \n Effekt der mittleren oberfl. rel. Bodenfeuchte", ylab = "log. Odds")
dev.off()

# Glorad
jpeg("./Plots/Max/glorad_winter_saale.jpeg", width = 750, height = 620)
plot(gam_uni_selected_winter_20203, ylim = c(-7, 7), xlab = "Rolling mean einfallende kurzwellige Strahlung \n (letzte 7 Tage; zentriert)", xlim = c(-250, 600), select = 3, main = "Fränkische Saale Salz \n Effekt der mittleren einfallenden kurzwelligen Strahlung", ylab = "log. Odds")
dev.off()

# Lufttemperatur
jpeg("./Plots/Max/airtmp_winter_saale.jpeg", width = 750, height = 620)
plot(gam_uni_selected_winter_20203, ylim = c(-7, 7), xlim = c(-15, 15), xlab = "Rolling mean Lufttemperatur \n (letzte 7 Tage; zentriert)", select = 2, main = "Fränkische Saale Salz \n Effekt der mittleren Lufttemperatur", ylab = "log. Odds")
dev.off()

# Summer
# Isar Summer
# Soilwater
jpeg("./Plots/Max/soilwater_summer_isar.jpeg", width = 750, height = 620)
plot(gam_uni_selected_summer_10304, ylim = c(-7, 7), xlim = c(-5, 2), xlab = "Rolling mean oberflächennahe rel. Bodenfeuchte \n (letzte 60 Tage; zentriert, skaliert)", select = 4, main = "Isar Mittenwald \n Effekt der mittleren oberfl. rel. Bodenfeuchte", ylab = "log. Odds")
dev.off()
# Snowstorage
jpeg("./Plots/Max/snow_summer_isar.jpeg", width = 750, height = 620)
plot(gam_uni_selected_summer_10304, ylim = c(-7, 7), xlim =  c(-50, 50), xlab = "Rolling mean Schneespeicher \n (letzte 30 Tage; zentriert)", select = 5, main = "Isar Mittenwald \n Effekt des mittleren Schneespeichers", ylab = "log. Odds")
dev.off()
# Niederschlag
jpeg("./Plots/Max/precip_summer_isar.jpeg", width = 750, height = 620)
plot(gam_uni_selected_summer_10304, ylim = c(-7, 7), xlim = c(-5, 5), xlab = "Rolling mean Niederschlag \n (letzte 7 Tage; zentriert)", select = 1, main = "Isar Mittenwald \n Effekt des mittleren Niederschlags", ylab = "log. Odds")
dev.off()

# Iller Summer
# Soilwater
jpeg("./Plots/Max/soilwater_summer_iller.jpeg", width = 750, height = 620)
plot(gam_uni_selected_summer_11502, ylim = c(-7, 7), xlim = c(-5, 2), xlab = "Rolling mean oberflächennahe rel. Bodenfeuchte \n (letzte 60 Tage; zentriert, skaliert)", select = 4, main = "Iller Kempten \n Effekt der mittleren oberfl. rel. Bodenfeuchte", ylab = "log. Odds")
dev.off()
# Snowstorage
jpeg("./Plots/Max/snow_summer_iller.jpeg", width = 750, height = 620)
plot(gam_uni_selected_summer_11502, ylim = c(-7, 7), xlim =  c(-50, 50), xlab = "Rolling mean Schneespeicher \n (letzte 30 Tage; zentriert)", select = 5, main = "Iller Kempten \n Effekt des mittleren Schneespeichers", ylab = "log. Odds")
dev.off()
# Niederschlag
jpeg("./Plots/Max/precip_summer_iller.jpeg", width = 750, height = 620)
plot(gam_uni_selected_summer_11502, ylim = c(-7, 7), xlim = c(-5, 5), xlab = "Rolling mean Niederschlag \n (letzte 7 Tage; zentriert)", select = 1, main = "Iller Kempten \n Effekt des mittleren Niederschlags", ylab = "log. Odds")
dev.off()
```

# Selektierte Modelle für alle Pregel und Halbjahre
## 2
```{r}
# nur Treiber: avg_airtmp, avg_relhum, avg_soilwater, avg_snowstorage, groundwaterdepth, avg_infiltration um Multikollinearität zu vermeiden (in keinem der 6 Datensätze eine Korrelation von > 0.8 bzw. <-0.8)
gam2_uni_selected_winter_10304 <- gam(formula = lowlevel ~ YY + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps"), family = binomial(), data = hydro_winter_10304_kbe, method = "REML")
summary(gam2_uni_selected_winter_10304)
AIC(gam2_uni_selected_winter_10304)
BIC(gam2_uni_selected_winter_10304)
concurvity(gam2_uni_selected_winter_10304)
#plot(gam2_uni_selected_winter_10304, ylim = c(-7, 7))


gam2_uni_selected_summer_10304 <- gam(formula = lowlevel ~ YY + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps"), family = binomial(), data = hydro_summer_10304_kbe, method = "REML")
summary(gam2_uni_selected_summer_10304)
AIC(gam2_uni_selected_summer_10304)
BIC(gam2_uni_selected_summer_10304)
concurvity(gam2_uni_selected_summer_10304)
#plot(gam2_uni_selected_summer_10304, ylim = c(-7, 7))


gam2_uni_selected_winter_11502 <- gam(formula = lowlevel ~ YY + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps"), family = binomial(), data = hydro_winter_11502_kbe, method = "REML")
summary(gam2_uni_selected_winter_11502)
AIC(gam2_uni_selected_winter_11502)
BIC(gam2_uni_selected_winter_11502)
concurvity(gam2_uni_selected_winter_11502)
#plot(gam2_uni_selected_winter_11502, ylim = c(-7, 7))


gam2_uni_selected_summer_11502 <- gam(formula = lowlevel ~ YY + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps"), family = binomial(), data = hydro_summer_11502_kbe, method = "REML")
summary(gam2_uni_selected_summer_11502)
AIC(gam2_uni_selected_summer_11502)
BIC(gam2_uni_selected_summer_11502)
concurvity(gam2_uni_selected_summer_11502)
#plot(gam2_uni_selected_summer_11502, ylim = c(-7, 7))


gam2_uni_selected_winter_20203 <- gam(formula = lowlevel ~ YY + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")
summary(gam2_uni_selected_winter_20203)
AIC(gam2_uni_selected_winter_20203)
BIC(gam2_uni_selected_winter_20203)
concurvity(gam2_uni_selected_winter_20203)
#plot(gam2_uni_selected_winter_20203, ylim = c(-7, 7))


gam2_uni_selected_summer_20203 <- gam(formula = lowlevel ~ YY + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")
summary(gam2_uni_selected_summer_20203)
AIC(gam2_uni_selected_summer_20203)
BIC(gam2_uni_selected_summer_20203)
concurvity(gam2_uni_selected_summer_20203)
#plot(gam2_uni_selected_summer_20203, ylim = c(-7, 7))
```


# Selektierte Modelle für alle Pregel und Halbjahre mit individuellen Interaktionen
```{r}
# 10304, Winter
gam_uni_selected_interac_winter_10304 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_relhum, bs = "ps")+ s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(avg_infiltration, bs = "ps") + s(avg_snowstorage_drain, bs = "ps") + s(groundwaterdepth, bs = "ps", by = avg_glorad), family = binomial(), data = hydro_winter_10304_kbe, method = "REML")
AIC(gam_uni_selected_interac_winter_10304)
summary(gam_uni_selected_interac_winter_10304)

# 10304, Summer
gam_uni_selected_interac_summer_10304 <- gam(formula = lowlevel ~ YY + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps"), family = binomial(), data = hydro_summer_10304_kbe, method = "REML")




# mit ti
# 10304, Winter
gam_uni_selected_interac_winter_10304 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(avg_snowstorage_drain, bs = "ps") + ti(avg_glorad, avg_snowstorage, bs = "ps") + ti(avg_soilwater, groundwaterdepth, bs = "ps"), family = binomial(), data = hydro_winter_10304_kbe, method = "REML")
AIC(gam_uni_selected_interac_winter_10304)
summary(gam_uni_selected_interac_winter_10304)

# 10304, Summer
gam_uni_selected_interac_summer_10304 <- gam(formula = lowlevel ~ YY + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + ti(avg_soilwater, groundwaterdepth, bs = "ps") + ti(avg_airtmp, avg_infiltration, bs = "ps"), family = binomial(), data = hydro_summer_10304_kbe, method = "REML")
AIC(gam_uni_selected_interac_summer_10304)
summary(gam_uni_selected_interac_summer_10304)

# 11502, Winter
gam_uni_selected_interac_winter_11502 <- gam(formula = lowlevel ~ YY + s(avg_precip, bs = "ps") + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(avg_snowstorage_drain, bs = "ps") + ti(avg_snowstorage, groundwaterdepth, bs = "ps"), family = binomial(), data = hydro_winter_11502_kbe, method = "REML")
AIC(gam_uni_selected_interac_winter_11502)
summary(gam_uni_selected_interac_winter_11502)

# 11502, Summer
gam_uni_selected_interac_summer_11502 <- gam(formula = lowlevel ~ YY  + s(avg_airtmp, bs = "ps") + s(avg_glorad, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + ti(avg_soilwater, groundwaterdepth, bs = "ps") + ti(avg_airtmp, avg_infiltration, bs = "ps"), family = binomial(), data = hydro_summer_11502_kbe, method = "REML")
AIC(gam_uni_selected_interac_summer_11502)
summary(gam_uni_selected_interac_summer_11502)

# 20203, Winter
gam_uni_selected_interac_winter_20203 <- gam(formula = lowlevel ~ YY  + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(avg_snowstorage, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps") + s(avg_snowstorage_drain, bs = "ps") + ti(avg_airtmp, groundwaterdepth, bs = "ps") + ti(avg_soilwater, avg_snowstorage, bs = "ps"), family = binomial(), data = hydro_winter_20203_kbe, method = "REML")
AIC(gam_uni_selected_interac_winter_20203)
summary(gam_uni_selected_interac_winter_20203)

# 20203, Summer
# avg_snowstorage und avg_snowstorage_drain aufgrund von mangender Varianz in den Daten herausgenommen  
gam_uni_selected_interac_summer_20203 <- gam(formula = lowlevel ~ YY  + s(avg_airtmp, bs = "ps") + s(avg_relhum, bs = "ps") + s(avg_soilwater, bs = "ps") + s(groundwaterdepth, bs = "ps") + s(avg_infiltration, bs = "ps")  + ti(avg_soilwater, groundwaterdepth, bs = "ps") + ti(avg_airtmp, avg_infiltration, bs = "ps"), family = binomial(), data = hydro_summer_20203_kbe, method = "REML")
AIC(gam_uni_selected_interac_summer_20203)
summary(gam_uni_selected_interac_summer_20203)
```

# ROC Analysis for final models
```{r}
# Setup test set
hydro_winter_11502_test <- hydro_winter_11502 %>% filter(member != "kbe")
hydro_winter_11502_test$lowlevel <- as.logical(hydro_winter_11502_test$lowlevel)

hydro_summer_11502_test <- hydro_summer_11502 %>% filter(member != "kbe")
hydro_summer_11502_test$lowlevel <- as.logical(hydro_summer_11502_test$lowlevel)

hydro_winter_10304_test <- hydro_winter_10304 %>% filter(member != "kbe")
hydro_winter_10304_test$lowlevel <- as.logical(hydro_winter_10304_test$lowlevel)

hydro_summer_10304_test <- hydro_summer_10304 %>% filter(member != "kbe")
hydro_summer_10304_test$lowlevel <- as.logical(hydro_summer_10304_test$lowlevel)

hydro_winter_20203_test <- hydro_winter_20203 %>% filter(member != "kbe")
hydro_winter_20203_test$lowlevel <- as.logical(hydro_winter_20203_test$lowlevel)

hydro_summer_20203_test <- hydro_summer_20203 %>% filter(member != "kbe")
hydro_summer_20203_test$lowlevel <- as.logical(hydro_summer_20203_test$lowlevel)


# gam_uni_selected_interac_winter_10304
hydro_winter_10304_pred <- predict(gam_uni_selected_interac_winter_10304, hydro_winter_10304_test, type = "response")
roc.plot(hydro_winter_10304_test$lowlevel, hydro_winter_10304_pred, xlab = "1 - Spezifität", ylab = "Sensitivität")

hydro_summer_10304_pred <- predict(gam_uni_selected_interac_summer_10304, hydro_summer_10304_test, type = "response")
roc.plot(hydro_summer_10304_test$lowlevel, hydro_summer_10304_pred, xlab = "1 - Spezifität", ylab = "Sensitivität")

hydro_winter_11502_pred <- predict(gam_uni_selected_interac_winter_11502, hydro_winter_11502_test, type = "response")
roc.plot(hydro_winter_11502_test$lowlevel, hydro_winter_11502_pred, xlab = "1 - Spezifität", ylab = "Sensitivität")

hydro_summer_11502_pred <- predict(gam_uni_selected_interac_summer_11502, hydro_summer_11502_test, type = "response")
roc.plot(hydro_summer_11502_test$lowlevel, hydro_summer_11502_pred, xlab = "1 - Spezifität", ylab = "Sensitivität")

hydro_winter_20203_pred <- predict(gam_uni_selected_interac_winter_20203, hydro_winter_20203_test, type = "response")
roc.plot(hydro_winter_20203_test$lowlevel, hydro_winter_20203_pred, xlab = "1 - Spezifität", ylab = "Sensitivität")

hydro_summer_20203_pred <- predict(gam_uni_selected_interac_summer_20203, hydro_summer_20203_test, type = "response")
roc.plot(hydro_summer_20203_test$lowlevel, hydro_summer_20203_pred, xlab = "1 - Spezifität", ylab = "Sensitivität")
```

